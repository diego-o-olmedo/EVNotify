<!DOCTYPE html>
<html>
    <head>
        <title>EVNotify</title>
        <meta charset="utf-8"></meta>
        <!-- Client Variables -->
        <script src="./client.js"></script>
        <!-- jQuery -->
        <script src="./js/jquery-3.2.0.min.js"></script>
        <!-- Cordova -->
        <script src="cordova.js"></script>
        <!-- Promise polyfill -->
        <script src="./js/promise.js"></script>
        <!-- Material CSS -->
        <link rel="stylesheet" href="./css/material.min.css">
        <!-- EVNotify CSS -->
        <link rel="stylesheet" href="./css/evnotify.css">
        <!-- Material JS -->
        <script src="./js/material.min.js"></script>
        <!-- Progressbar JS -->
        <script src="./js/progressbar.min.js"></script>
        <!-- GetMDL Select CSS -->
        <link rel="stylesheet" href="./css/getmdl-select.min.css">
        <!-- GetMDL Select JS -->
        <script src="./js/getmdl-select.min.js"></script>
        <!-- SweetAlert2 JS -->
        <script src="./js/sweetalert2.min.js"></script>
        <!-- SweetAlert2 CSS -->
        <link rel="stylesheet" href="./css/sweetalert2.min.css">
        <!-- storage JS -->
        <script src="./js/storage.js"></script>
        <!-- server JS -->
        <script src="./js/server.js"></script>
        <!-- user JS -->
        <script src="./js/user.js"></script>
        <!-- german translation -->
        <script src="./lng/de.js"></script>
        <!-- english translation -->
        <script src="./lng/en.js"></script>
        <!-- translation JS -->
        <script src="./lng/index.js"></script>
        <script>
        /**
         * Function which loads several other functions on page load
         * NOTE: Binds deviceReady event to use device API's such as the required bluetooth plugin
         */
        function onLoad() {
            translatePage(getValue('lng', 'en'));
            // update selects
            getmdlSelect.init('.getmdl-select');
            document.addEventListener("deviceready", onDeviceReady, false);
        }

        /**
         * Function which gets triggered when device is ready and the bluetooth plugin should be usable
         * NOTE: fills the bluetooth devices list with paired ones
         */
        function onDeviceReady() {
            // build deviceList
            var deviceList = document.getElementById('deviceList'),
                s = document.createElement('script');

            // append bluetooth file to body
            s.type = 'text/javascript';
            s.src = './js/bluetooth.js';
            $('head').append(s);

            if(typeof bluetooth !== 'undefined') {
                bluetooth.list(function(err, devices) {
                    if(!err && devices) {
                        // iterate through received paired devices to list them
                        devices.forEach(function(device) {
                            var li = document.createElement('li');

                            li.className += 'mdl-menu__item';
                            li.innerText = device.name;
                            li.setAttribute('data-val', device.id);
                            deviceList.appendChild(li);
                        });

                        // update deviceDiv and DOM
                        getmdlSelect.init('#deviceDiv');
                        componentHandler.upgradeDom();
                    }
                });
            }
        }

        /**
         * Function which loads the settings and applies them to the specific page elements
         */
        function loadSettings() {
            var config = JSON.parse(getValue('config', '{}')),
                akey = document.getElementById('akey'),
                akeyDiv = document.getElementById('akeyDiv'),
                email = document.getElementById('email'),
                emailDiv = document.getElementById('emailDiv'),
                notifyVal = document.getElementById('notifyVal'),
                notifySlider = document.getElementById('notifySlider'),
                device = document.getElementById('device'),
                deviceDiv = document.getElementById('deviceDiv'),
                polling = document.getElementById('polling'),
                pollingDiv = document.getElementById('pollingDiv'),
                sync = document.getElementById('sync'),
                syncDiv = document.getElementById('syncDiv'),
                language = document.getElementById('language'),
                languageDiv = document.getElementById('languageDiv');

            if(getValue('akey')) {
                akey.value = getValue('akey');
                akeyDiv.className += ' is-upgraded is-focused';
            }
            if(config.email) {
                email.value = config.email;
                emailDiv.className += ' is-upgraded is-focused';
            }
            if(config.soc) {
                notifyVal.innerText = config.soc + ' %';
                notifySlider.MaterialSlider.change(config.soc);
            }
            if(config.deviceObj) {
                deviceDiv.className += ' is-dirty is-focused';
                device.value = config.deviceObj.name;
                device.setAttribute('data-val', config.deviceObj.id);
            }
            if(config.pollingObj) {
                pollingDiv.className += ' is-dirty is-focused';
                polling.value = config.pollingObj.title;
                polling.setAttribute('data-val', config.pollingObj.val);
            }
            if(config.syncObj) {
                syncDiv.className += ' is-dirty is-focused';
                sync.value = config.syncObj.title;
                sync.setAttribute('data-val', config.syncObj.val);
            }
            if(config.lngObj) {
                languageDiv.className += ' is-dirty is-focused';
                language.value = translate(config.lngObj.name, config.lngObj.lng);
                language.setAttribute('data-val', config.lngObj.lng);
                setValue('lng', config.lngObj.lng);
            }
            if(parseInt(getValue('telegram'), 0) > 0) {
                document.getElementById('telegramCheckbox').className += ' is-upgraded is-checked';
            }

            translatePage(getValue('lng', 'en'));
        }

        /**
         * Function which saves the settings and sends the new settings to backend server
         * NOTE: Requires the users account password to authenticate to prevent abuse
         */
        function saveSettings() {
            var lngVal = document.getElementById('language').getAttribute('data-val'),
                lng = setValue('lng', ((lngVal && lngVal !== 'null')? lngVal : getValue('lng', 'en'))),
                settingsObj = setValue('config', {
                    lngObj: {
                        lng: lng,
                        name: document.getElementById('language').value
                    },
                    lng: lng,
                    car: 'IONIQ',   // later it will supports more cars
                    telegram: getValue('telegram'),
                    email: document.getElementById('email').value,
                    push: false,
                    soc: parseInt(document.getElementById('notifyVal').innerText.split(' ')[0]),
                    deviceObj: {
                        id: document.getElementById('device').getAttribute('data-val'),
                        name: document.getElementById('device').value
                    },
                    device: document.getElementById('device').getAttribute('data-val'),
                    pollingObj: {
                        val: parseInt(document.getElementById('polling').getAttribute('data-val')),
                        title: document.getElementById('polling').value
                    },
                    polling: parseInt(document.getElementById('polling').getAttribute('data-val')),
                    syncObj: {
                        val: parseInt(document.getElementById('sync').getAttribute('data-val')),
                        title: document.getElementById('sync').value
                    },
                    autoSync: parseInt(document.getElementById('sync').getAttribute('data-val'))
                });

            translatePage(lng);

            swal({
                title: translate('SETTINGS_PASSWORD', lng),
                text: translate('SETTINGS_PASSWORD_TEXT', lng),
                input: 'password',
                showCancelButton: true,
                confirmButtonText: translate('NEXT', lng),
                cancelButtonText: translate('CANCEL', lng),
                showLoaderOnConfirm: true,
                inputValidator: function (input) {
                    return new Promise(function (resolve, reject) {
                        if (input.length >= 6) resolve();
                        else reject(translate('PASSWORD_LENGTH_ERROR', lng));
                    });
                },
                preConfirm: function (password) {
                    return new Promise(function (resolve, reject) {
                        setTimeout(function() {
                            // get user settings to fetch telegram information to prevent overwrite
                            sendRequest('settings', {
                                akey: getValue('akey'),
                                password: password,
                                token: getValue('token'),
                                option: 'GET'
                            }, function(err, settingsRes) {
                                if(!err && settingsRes && settingsRes.settings) {
                                    // update telegram value
                                    settingsObj.telegram = setValue('telegram', settingsRes.settings.telegram);
                                    // update the settings
                                    sendRequest('settings', {
                                        akey: getValue('akey'),
                                        password: password,
                                        token: getValue('token'),
                                        option: 'SET',
                                        optionObj: settingsObj
                                    }, function(err, settingsRes) {
                                        if(!err && settingsRes) resolve();
                                        else reject(translate('SET_SETTINGS_FAILED', lng));
                                    });
                                } else reject(translate('GET_SETTINGS_FAILED', lng));
                            });
                        }, 2000);
                    });
                },
                allowOutsideClick: false
            }).then(function () {
                swal({
                    type: 'success',
                    title: translate('SET_SETTINGS_SUCCESSFUL', lng)
                });
            });
        }

        function manageTelegram(lng) {
            swal({
                title: translate('SETTINGS_PASSWORD', lng),
                text: translate('SETTINGS_PASSWORD_TEXT', lng),
                input: 'password',
                showCancelButton: true,
                confirmButtonText: translate('NEXT', lng),
                cancelButtonText: translate('CANCEL', lng),
                showLoaderOnConfirm: true,
                inputValidator: function (input) {
                    return new Promise(function (resolve, reject) {
                        if (input.length >= 6) resolve();
                        else reject(translate('PASSWORD_LENGTH_ERROR', lng));
                    });
                },
                preConfirm: function (password) {
                    return new Promise(function (resolve, reject) {
                        setTimeout(function() {
                            // get user settings
                            sendRequest('settings', {
                                akey: getValue('akey'),
                                password: password,
                                token: getValue('token'),
                                option: 'GET'
                            }, function(err, settingsRes) {
                                if(!err && settingsRes && settingsRes.settings) {
                                    // update telegram value
                                    setValue('telegram', settingsRes.settings.telegram);
                                    resolve();
                                } else reject(translate('GET_SETTINGS_FAILED', lng));
                            });
                        }, 2000);
                    });
                },
                allowOutsideClick: false
            }).then(function () {
                if(parseInt(getValue('telegram', 0)) > 0) {
                    // instruction of how to unsubscribe
                    swal({
                        type: 'info',
                        title: translate('TELEGRAM_UNSUBSCRIBE', lng),
                        html: translate('TELEGRAM_UNSUBSCRIBE_TEXT', lng)
                    });
                } else {
                    // instruction of how to subscribe
                    swal({
                        type: 'info',
                        title: translate('TELEGRAM_SUBSCRIBE', lng),
                        html: translate('TELEGRAM_SUBSCRIBE_TEXT', lng) + '<br>Token: ' + getValue('token')
                    });
                }
            });
        }

        /**
        * Function to switch account, retrieve new settings and save them
        * @param  {String} lng the language to use for the dialogs
        */
        function switchAccount(lng) {
            swal.queue([{
                title: translate('SWITCH_ACCOUNT', lng),
                text: translate('SWITCH_ACCOUNT_TEXT', lng),
                input: 'text',
                showLoaderOnConfirm: true,
                allowOutsideClick: false,
                inputValidator: function (input) {
                    return new Promise(function (resolve, reject) {
                        if (input.length === 6) resolve();
                        else reject(translate('AKEY_LENGTH_ERROR', lng));
                    });
                },
                preConfirm: function(akey) {
                    return new Promise(function (resolve, reject) {
                        // save entered akey
                        setValue('akey', akey);
                        // add password modal for login
                        swal.insertQueueStep({
                            title: translate('LOGIN_PASSWORD', lng),
                            text: translate('LOGIN_PASSWORD_TEXT', lng),
                            input: 'password',
                            showLoaderOnConfirm: true,
                            allowOutsideClick: false,
                            inputValidator: function (input) {
                                return new Promise(function (resolve, reject) {
                                    if (input.length >= 6) resolve();
                                    else reject(translate('PASSWORD_LENGTH_ERROR', lng));
                                });
                            },
                            preConfirm: function(password) {
                                return new Promise(function (resolve, reject) {
                                    setTimeout(function () {
                                        // login account
                                        sendRequest('login', {akey: getValue('akey'), password: password}, function(err, regRes) {
                                            if(!err && regRes) {
                                                setValue('token', regRes.token);
                                                // get and save current settings from new linked account
                                                syncSettings('pull', function(err, syncRes) {
                                                    if(!err) resolve();
                                                    else reject(translate('SYNC_SETTINGS_FAILED', lng));
                                                });
                                            } else reject(translate('LOGIN_FAILED', lng));
                                        });
                                    }, 2000);
                                });
                            }
                        });
                        resolve();
                    });
                }
            }]).then(function() {
                swal({
                    type: 'success',
                    title: translate('SWITCH_ACCOUNT_SUCCESSFUL', lng)
                });
            });
        }

        /**
         * Function which allows to sync settings based on the type (pull/push)
         * NOTE: if no type is specified, a dialog prompts the user for the action to use
         * @param  {[type]}   type     [description]
         * @param  {Function} callback [description]
         * @return {[type]}            [description]
         */
        function syncSettings(type, callback) {
            var pullSettings = function(callback) {
                    // get the settings from server
                    sendRequest('sync', {akey: getValue('akey'), token: getValue('token'), type: 'pull'}, function(err, syncRes) {
                        if(!err && syncRes && syncRes.syncRes) {
                            var settings = JSON.parse(getValue('config', '{}'));

                            // overwrite specific keys
                            settings.email = syncRes.syncRes.email;
                            settings.telegram = syncRes.syncRes.telegram;
                            settings.soc = syncRes.syncRes.soc;
                            settings.curSoC = syncRes.syncRes.curSoC;
                            settings.polling = syncRes.syncRes.polling;
                            settings.autoSync = syncRes.syncRes.autoSync;
                            settings.lng = syncRes.syncRes.lng;
                            settings.push = syncRes.syncRes.push;
                            // save new settings
                            setValue('config', settings);
                            loadSettings();
                        }
                        callback(err, syncRes);
                    });
                },
                pushSettings = function(callback) {
                    // push the current settings to server
                    sendRequest('sync', {akey: getValue('akey'), token: getValue('token'), type: 'push', syncObj: JSON.parse(getValue('config', '{}'))}, function(err, syncRes) {
                        callback(err, syncRes);
                    });
                },
                lng = getValue('lng', 'en');

            if(type === 'pull') {
                // pull settings
                pullSettings(function(err, pullRes) {
                    callback(err, pullRes);
                });
            } else if(type === 'push') {
                // push settings
                pushSettings(function(err, pushRes) {
                    callback(err, pushRes);
                });
            } else {
                // show dialog
                swal({
                    title: translate('SYNC', lng),
                    text: translate('SYNC_TEXT', lng),
                    input: 'select',
                    inputOptions: {pull: translate('SYNC_TYPE_PULL', lng), sync: translate('SYNC_TYPE_PUSH', lng)},
                    preConfirm: function (syncType) {
                        return new Promise(function (resolve, reject) {
                            setTimeout(function() {
                                if(syncType === 'pull') {
                                    pullSettings(function(err, pullRes) {
                                        if(!err) resolve();
                                        else reject(translate('SYNC_SETTINGS_FAILED', lng));
                                    });
                                } else {
                                    pushSettings(function(err, pushRes) {
                                        if(!err) resolve();
                                        else reject(translate('SYNC_SETTINGS_FAILED', lng));
                                    });
                                }
                            }, 2000);
                        });
                    }
                }).then(function() {
                    swal({
                        type: 'success',
                        title: translate('SYNC_SETTINGS_SUCCESSFUL', lng)
                    });
                });
            }
        }
        </script>
    </head>
    <body onload="onLoad(); loadSettings()">
        <!-- Always shows a header, even on smaller screens. -->
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
            <header class="mdl-layout__header">
                <div class="mdl-layout__header-row">
                    <!-- Title -->
                    <span class="mdl-layout-title translate" id="HEADER_SETTINGS"></span>
                    <!-- Add spacer, to align navigation to the right -->
                    <div class="mdl-layout-spacer"></div>
                    <label class="mdl-button mdl-js-button mdl-button--icon">
                        <img class="material-icons" onclick="switchAccount(getValue('lng', 'en'))" src="./icons/account.svg"></img>
                    </label>
                    <label class="mdl-button mdl-js-button mdl-button--icon">
                        <img class="material-icons" onclick="syncSettings()" src="./icons/sync.svg"></img>
                    </label>
                </div>
            </header>
            <div class="mdl-layout__drawer">
                <span class="mdl-layout-title translate" id="TITLE_EVNOTIFY"></span>
                <nav class="mdl-navigation">
                    <a class="mdl-navigation__link translate" href="index.html" id="MENU_OVERVIEW"></a>
                    <a class="mdl-navigation__link translate" href="" id="MENU_CHARGE"></a>
                    <a class="mdl-navigation__link translate" href="" id="MENU_NOTIFYME"></a>
                    <a class="mdl-navigation__link translate" href="settings.html" id="MENU_SETTINGS"></a>
                </nav>
            </div>
            <main class="mdl-layout__content">
                <div class="page-content">
                    <!-- Your content goes here -->
                    <form action="#" id="settingsForm">
                        <!-- Account -->
                        <span class="mdl-textfield settingsSection translate" id="SETTINGS_ACCOUNT"></span>
                        <!-- AKey -->
                        <div id="akeyDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label settingsPart">
                            <input class="mdl-textfield__input" type="text" readonly="readonly" id="akey">
                            <label class="mdl-textfield__label translate" for="akey" id="SETTINGS_AKEY"></label>
                        </div>
                        <!-- Password -->
                        <button onclick="event.preventDefault(); changePW(getValue('lng', 'en'))"
                            class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect pwBtn translate" id="CHANGE_PASSWORD">
                        </button>
                        <!-- Language -->
                        <div id="languageDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height marginLeft">
                            <input class="mdl-textfield__input" type="text" id="language" readonly tabIndex="-1">
                            <label for="language">
                                <img class="mdl-icon-toggle__label material-icons" src="./icons/keyboard_arrow_down.svg"></img>
                            </label>
                            <label for="language" class="mdl-textfield__label translate" id="LANGUAGE"></label>
                            <ul for="language" class="mdl-menu mdl-menu--bottom-left mdl-js-menu" id="languageList">
                                <li class="mdl-menu__item translate" data-val="en" id="LNG_EN"></li>
                                <li class="mdl-menu__item translate" data-val="de" id="LNG_DE"></li>
                            </ul>
                        </div>
                        <!-- Notifications -->
                        <span class="mdl-textfield settingsSection translate" id="NOTIFICATIONS"></span>
                        <!-- E-Mail -->
                        <div id="emailDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label settingsPart">
                            <input class="mdl-textfield__input" type="email" id="email">
                            <label class="mdl-textfield__label translate" for="email" id="EMAIL_NOTIFICATION"></label>
                        </div>
                        <!-- Push -->
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect marginLeft" for="push">
                            <input type="checkbox" id="push" disabled="true" class="mdl-checkbox__input">
                            <span class="mdl-checkbox__label translate" id="PUSH_NOTIFICATION"></span>
                        </label>
                        <!-- Telegram -->
                        <label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect marginLeft" for="telegram" id="telegramCheckbox">
                            <input type="checkbox" id="telegram" disabled="true" class="mdl-checkbox__input">
                            <span class="mdl-checkbox__label translate" id="TELEGRAM_NOTIFICATION"></span><br>
                            <a class="translate" onclick="manageTelegram(getValue('lng', 'en'))" id="TELEGRAM_MANAGE_NOTIFICATION"></a>
                        </label><br><br>
                        <!-- Notifcation SoC value -->
                        <p style="text-align: center">
                            <input id="notifySlider" class="mdl-slider mdl-js-slider" type="range" min="10" max="100" tabindex="0" oninput="document.getElementById('notifyVal').innerText = this.value + ' %';">
                            <span style="text-align: center; font-weight: bold; display: block" class="mdl-textfield__info marginLeft" id="notifyVal">70 %</span>
                            <span style="text-align: center" class="mdl-textfield__info marginLeft translate" id="SETTINGS_SOC_HELP"></span>
                        </p>
                        <!-- System -->
                        <span class="mdl-textfield settingsSection translate" id="SETTINGS_SYSTEM"></span>
                        <!-- Device -->
                        <div id="deviceDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height marginLeft">
                            <input class="mdl-textfield__input" type="text" id="device" readonly tabIndex="-1">
                            <label for="device">
                                <img class="mdl-icon-toggle__label material-icons" src="./icons/keyboard_arrow_down.svg"></img>
                            </label>
                            <label for="device" class="mdl-textfield__label translate" id="SETTINGS_DEVICES"></label>
                            <ul for="device" class="mdl-menu mdl-menu--bottom-left mdl-js-menu" id="deviceList">
                            </ul>
                        </div>
                        <!-- Polling -->
                        <div id="pollingDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height marginLeft">
                            <input class="mdl-textfield__input" type="text" id="polling" readonly tabIndex="-1">
                            <label for="polling">
                                <img class="mdl-icon-toggle__label material-icons" src="./icons/keyboard_arrow_down.svg"></img>
                            </label>
                            <label for="polling" class="mdl-textfield__label translate" id="SETTINGS_POLLING"></label>
                            <ul for="polling" class="mdl-menu mdl-menu--bottom-left mdl-js-menu" id="pollingList">
                                <li class="mdl-menu__item translate" data-val="5" id="INTERVAL_5"></li>
                                <li class="mdl-menu__item translate" data-val="10" id="INTERVAL_10"></li>
                                <li class="mdl-menu__item translate" data-val="30" id="INTERVAL_30"></li>
                                <li class="mdl-menu__item translate" data-val="60" id="INTERVAL_60"></li>
                                <li class="mdl-menu__item translate" data-val="300" id="INTERVAL_300"></li>
                                <li class="mdl-menu__item translate" data-val="600" id="INTERVAL_600"></li>
                                <li class="mdl-menu__item translate" data-val="1800" id="INTERVAL_1800"></li>
                                <li class="mdl-menu__item translate" data-val="3600" id="INTERVAL_3600"></li>
                            </ul>
                        </div>
                        <span style="visibility: visible" class="mdl-textfield__error marginLeft translate" id="POLLING_WARNING"></span><br><br><br>
                        <!-- Sync -->
                        <div id="syncDiv" class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label getmdl-select getmdl-select__fix-height marginLeft">
                            <input class="mdl-textfield__input" type="text" id="sync" readonly tabIndex="-1">
                            <label for="sync">
                                <img class="mdl-icon-toggle__label material-icons" src="./icons/keyboard_arrow_down.svg"></img>
                            </label>
                            <label for="sync" class="mdl-textfield__label translate" id="SETTINGS_SYNC"></label>
                            <ul for="sync" class="mdl-menu mdl-menu--bottom-left mdl-js-menu" id="syncList">
                                <li class="mdl-menu__item translate" data-val="0" id="INTERVAL_0"></li>
                                <li class="mdl-menu__item translate" data-val="30" id="INTERVAL_30"></li>
                                <li class="mdl-menu__item translate" data-val="60" id="INTERVAL_60"></li>
                                <li class="mdl-menu__item translate" data-val="300" id="INTERVAL_300"></li>
                                <li class="mdl-menu__item translate" data-val="600" id="INTERVAL_600"></li>
                                <li class="mdl-menu__item translate" data-val="1800" id="INTERVAL_1800"></li>
                                <li class="mdl-menu__item translate" data-val="3600" id="INTERVAL_3600"></li>
                            </ul>
                        </div>
                        <span style="visibility: visible" class="mdl-textfield__error marginLeft translate" id="SYNC_WARNING"></span><br>
                        <!-- Save Button -->
                        <button onclick="event.preventDefault(); saveSettings()" style="width: 100%; margin-top: 5%"
                            class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent mdl-js-ripple-effect translate" id="SAVE_SETTINGS">
                        </button>
                    </form>
                </div>
            </main>
        </div>
    </body>
</html>
